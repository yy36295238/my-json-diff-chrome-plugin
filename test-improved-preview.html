<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>改进后的JSON格式化预览测试</title>
    <link rel="stylesheet" href="styles-simple.css">
    <style>
        body {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .test-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin: 24px 0;
        }

        .test-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .panel-header {
            background: var(--primary-color);
            color: white;
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-content {
            padding: 16px;
        }

        .test-textarea {
            width: 100%;
            height: 300px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: var(--font-mono);
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            resize: vertical;
            line-height: 1.5;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .test-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .test-button.primary {
            background: var(--primary-color);
            color: white;
        }

        .test-button.secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .test-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .preview-area {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            height: 400px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .preview-body {
            flex: 1;
            overflow: auto;
            padding: 0;
        }

        .test-status {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            margin: 16px 0;
            font-family: var(--font-mono);
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        .status-item {
            margin: 4px 0;
            padding: 4px 8px;
            border-radius: 3px;
        }

        .status-success {
            background: rgba(var(--success-color-rgb), 0.1);
            color: var(--success-color);
        }

        .status-error {
            background: rgba(var(--error-color-rgb), 0.1);
            color: var(--error-color);
        }

        .status-info {
            background: rgba(var(--primary-color-rgb), 0.1);
            color: var(--primary-color);
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .metric-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <h1>🛠️ 改进后的JSON格式化预览功能测试</h1>

    <div class="metrics">
        <div class="metric-card">
            <div class="metric-value" id="nodeCount">0</div>
            <div class="metric-label">节点数量</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="maxDepth">0</div>
            <div class="metric-label">最大深度</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="collapsibleCount">0</div>
            <div class="metric-label">可折叠项</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="renderTime">0ms</div>
            <div class="metric-label">渲染时间</div>
        </div>
    </div>

    <div class="test-layout">
        <!-- 左侧：JSON输入 -->
        <div class="test-panel">
            <div class="panel-header">
                <span>📝 JSON数据输入</span>
                <span id="jsonStatus">等待输入</span>
            </div>
            <div class="panel-content">
                <textarea class="test-textarea" id="jsonInput" placeholder="在这里输入JSON数据...">
{
    "application": {
        "name": "JSON工具简化版",
        "version": "2.0.0",
        "description": "专业级JSON处理平台",
        "features": {
            "formatting": true,
            "comparison": true,
            "generation": true,
            "preview": {
                "collapsible": true,
                "syntax_highlighting": true,
                "tree_view": true,
                "auto_height": true
            }
        },
        "supported_data_types": [
            "string",
            "number",
            "boolean",
            "null",
            "object",
            "array"
        ],
        "configuration": {
            "theme": {
                "default": "light",
                "options": ["light", "dark"]
            },
            "editor": {
                "font_family": "Monaco, Menlo, monospace",
                "font_size": 14,
                "line_height": 1.6,
                "tab_size": 2
            },
            "preview": {
                "max_items_preview": 100,
                "auto_collapse_large_arrays": true,
                "show_data_types": true,
                "show_object_counts": true
            }
        },
        "test_data": {
            "users": [
                {
                    "id": 1,
                    "username": "admin",
                    "profile": {
                        "firstName": "管理员",
                        "lastName": "用户",
                        "email": "admin@example.com",
                        "preferences": {
                            "language": "zh-CN",
                            "timezone": "Asia/Shanghai",
                            "notifications": {
                                "email": true,
                                "sms": false,
                                "push": true
                            }
                        }
                    },
                    "permissions": ["read", "write", "delete", "admin"],
                    "last_login": "2024-01-01T12:00:00Z",
                    "active": true
                },
                {
                    "id": 2,
                    "username": "user1",
                    "profile": {
                        "firstName": "张",
                        "lastName": "三",
                        "email": "zhangsan@example.com",
                        "preferences": {
                            "language": "zh-CN",
                            "timezone": "Asia/Shanghai",
                            "notifications": {
                                "email": false,
                                "sms": true,
                                "push": false
                            }
                        }
                    },
                    "permissions": ["read", "write"],
                    "last_login": "2024-01-02T08:30:00Z",
                    "active": true
                }
            ],
            "statistics": {
                "total_users": 2,
                "active_users": 2,
                "last_updated": "2024-01-01T00:00:00Z"
            }
        }
    }
}
                </textarea>

                <div class="button-group">
                    <button class="test-button primary" onclick="updatePreview()">🔄 更新预览</button>
                    <button class="test-button secondary" onclick="formatJSON()">✨ 格式化</button>
                    <button class="test-button secondary" onclick="compressJSON()">📦 压缩</button>
                    <button class="test-button secondary" onclick="validateJSON()">✅ 验证</button>
                </div>
            </div>
        </div>

        <!-- 右侧：预览区域 -->
        <div class="test-panel">
            <div class="panel-header">
                <span>👁️ 格式化预览</span>
                <div class="button-group" style="margin: 0;">
                    <button class="test-button secondary" style="padding: 4px 8px; font-size: 12px;" onclick="expandAll()">展开</button>
                    <button class="test-button secondary" style="padding: 4px 8px; font-size: 12px;" onclick="collapseAll()">折叠</button>
                    <button class="test-button secondary" style="padding: 4px 8px; font-size: 12px;" onclick="toggleTreeView()">树形</button>
                </div>
            </div>
            <div class="panel-content" style="padding: 0;">
                <div class="preview-area">
                    <div class="preview-header">
                        <span>结构预览</span>
                        <span id="previewStats">等待数据</span>
                    </div>
                    <div class="preview-body">
                        <div id="jsonPreview" class="json-preview" style="min-height: 350px; height: auto;">
                            <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                                <div style="font-size: 48px; margin-bottom: 16px;">📋</div>
                                <div>在左侧输入JSON数据开始预览</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 测试状态 -->
    <div class="test-panel">
        <div class="panel-header">
            <span>📊 测试状态和日志</span>
            <button class="test-button secondary" style="padding: 4px 8px; font-size: 12px;" onclick="clearLog()">清除日志</button>
        </div>
        <div class="panel-content">
            <div class="test-status" id="testLog">
                <div class="status-info">📱 系统已就绪，等待测试...</div>
            </div>
        </div>
    </div>

    <script src="scripts.js"></script>
    <script>
        // 初始化应用
        const jsonTool = new JSONToolApp();
        let renderStartTime = 0;

        // 日志功能
        function addLog(message, type = 'info') {
            const log = document.getElementById('testLog');
            const time = new Date().toLocaleTimeString();
            const statusClass = type === 'error' ? 'status-error' :
                               type === 'success' ? 'status-success' : 'status-info';

            const logItem = document.createElement('div');
            logItem.className = `status-item ${statusClass}`;
            logItem.innerHTML = `[${time}] ${message}`;

            log.appendChild(logItem);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '<div class="status-info">📱 日志已清除</div>';
        }

        // 更新统计信息
        function updateMetrics(data) {
            try {
                const json = JSON.parse(data);
                const nodeCount = countNodes(json);
                const maxDepth = getMaxDepth(json);
                const collapsibleElements = document.querySelectorAll('.json-collapsible').length;
                const renderTime = Date.now() - renderStartTime;

                document.getElementById('nodeCount').textContent = nodeCount;
                document.getElementById('maxDepth').textContent = maxDepth;
                document.getElementById('collapsibleCount').textContent = collapsibleElements;
                document.getElementById('renderTime').textContent = renderTime + 'ms';

                document.getElementById('previewStats').textContent =
                    `${nodeCount}个节点 | ${maxDepth}层深度 | ${collapsibleElements}个可折叠项`;
            } catch (error) {
                // 忽略错误
            }
        }

        function countNodes(obj) {
            if (obj === null || typeof obj !== 'object') return 1;
            let count = 1;
            for (let key in obj) {
                count += countNodes(obj[key]);
            }
            return count;
        }

        function getMaxDepth(obj, depth = 0) {
            if (obj === null || typeof obj !== 'object') return depth;
            let maxDepth = depth;
            for (let key in obj) {
                maxDepth = Math.max(maxDepth, getMaxDepth(obj[key], depth + 1));
            }
            return maxDepth;
        }

        // 更新预览
        function updatePreview() {
            const input = document.getElementById('jsonInput').value.trim();
            const preview = document.getElementById('jsonPreview');
            const status = document.getElementById('jsonStatus');

            if (!input) {
                preview.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);"><div style="font-size: 48px; margin-bottom: 16px;">📋</div><div>请输入JSON数据</div></div>';
                status.textContent = '等待输入';
                status.style.color = 'var(--text-secondary)';
                addLog('预览区域已清空');
                return;
            }

            try {
                renderStartTime = Date.now();
                const parsed = JSON.parse(input);
                preview.innerHTML = jsonTool.renderJSONTree(parsed);

                status.textContent = '✅ 有效';
                status.style.color = 'var(--success-color)';

                updateMetrics(input);
                addLog('JSON预览更新成功', 'success');
            } catch (error) {
                preview.innerHTML = `<div style="padding: 20px; color: var(--error-color);"><strong>❌ JSON解析错误</strong><br><br>${error.message}</div>`;
                status.textContent = '❌ 无效';
                status.style.color = 'var(--error-color)';
                addLog(`JSON解析失败: ${error.message}`, 'error');
            }
        }

        // 格式化JSON
        function formatJSON() {
            const input = document.getElementById('jsonInput');
            try {
                const parsed = JSON.parse(input.value);
                input.value = JSON.stringify(parsed, null, 2);
                updatePreview();
                addLog('JSON格式化成功', 'success');
            } catch (error) {
                addLog(`格式化失败: ${error.message}`, 'error');
            }
        }

        // 压缩JSON
        function compressJSON() {
            const input = document.getElementById('jsonInput');
            try {
                const parsed = JSON.parse(input.value);
                input.value = JSON.stringify(parsed);
                updatePreview();
                addLog('JSON压缩成功', 'success');
            } catch (error) {
                addLog(`压缩失败: ${error.message}`, 'error');
            }
        }

        // 验证JSON
        function validateJSON() {
            const input = document.getElementById('jsonInput').value.trim();
            try {
                JSON.parse(input);
                addLog('✅ JSON格式验证通过', 'success');
            } catch (error) {
                addLog(`❌ JSON验证失败: ${error.message}`, 'error');
            }
        }

        // 展开所有
        function expandAll() {
            jsonTool.expandAll();
            addLog('已展开所有节点', 'info');
        }

        // 折叠所有
        function collapseAll() {
            jsonTool.collapseAll();
            addLog('已折叠所有节点', 'info');
        }

        // 切换树形视图
        function toggleTreeView() {
            jsonTool.toggleTreeView();
            const preview = document.getElementById('jsonPreview');
            const isTreeView = preview.classList.contains('tree-view');
            addLog(`已切换到${isTreeView ? '树形' : '普通'}视图`, 'info');
        }

        // 输入实时监听
        document.getElementById('jsonInput').addEventListener('input', function() {
            clearTimeout(this.updateTimer);
            this.updateTimer = setTimeout(updatePreview, 300);
        });

        // 页面加载完成
        window.addEventListener('load', function() {
            addLog('🚀 测试环境初始化完成', 'success');
            setTimeout(updatePreview, 500);
        });
    </script>
</body>
</html>